<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple React App</title>

   <link rel="stylesheet" href="react_main.css">

</head>
<body>

<div id="root"></div>


<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

<!-- REACT COMPONENTS -->
<script type="text/babel" src="react_intro.js"></script>
<script type="text/babel" src="react_step1.js"></script>
<script type="text/babel" src="react_step2.js"></script>
<script type="text/babel" src="react_step2point1.js"></script>
<script type="text/babel" src="react_step2point2.js"></script>
<script type="text/babel" src="react_song.js"></script>

<!-- FUNCTIONAL/HELPER SCRIPTS -->
 <script src="face-api.min.js"></script> 
 <script src="react_spotify_auth.js"></script>


<script type="text/babel">


const accessToken = localStorage.getItem("access_token");

const clientId = 'b5ac45b92b3243668cdb8390ab51a04d';
const redirectUri = 'https://www.jamesunderwood.net/facemusic/react_main.html';

const scope = 'user-top-read playlist-modify-private ugc-image-upload';
const authUrl = new URL("https://accounts.spotify.com/authorize")



  const App = () => {
    console.log("const App within react_main.html ")

    const { useEffect, useState, useRef } = React;
    const postIntroRef = useRef(null);

    const [curState, setCurState] = useState(() => {
    
      // Initialize state from local storage or use a default value
    return parseInt(localStorage.getItem('curState')) || 0;
  });


  const [loaded, setLoaded] = useState(false); //loaded is false only on first load, while loading/constructing DOM


  useEffect(() => {
    // Update local storage whenever curState changes
    localStorage.setItem('curState', curState.toString());


  if (curState > 0 && !loaded) { //If this is our first loading of the 
   postIntroRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' })

   //should this be through a ref?
   let introDiv = document.getElementById("intro");
   introDiv.scrollTop = introDiv.scrollHeight;
  }

  }, [curState,postIntroRef]);


useEffect(() => { //Forbid scrolling of the intro when postintro is still on screen / "anchoring" user
const myBody = document.getElementsByTagName("body")[0]
    myBody.addEventListener('scroll', function() {

      
      if (document.getElementById("intro").getBoundingClientRect().bottom >= document.documentElement.clientHeight) {
        document.getElementById("intro").style.overflow = "scroll";
      } else {
        document.getElementById("intro").style.overflow = "hidden";
      }
  });

}, []);


useEffect(() => { // Set loaded to true, but first check localstorage to see if user was previously further along
  
  if (!loaded && ( curState == 7 || curState == 6)) { // If we just loaded the page and the curstate is one of these
    console.log("it is now curstate " + curState);
    if (localStorage.getItem("access_token") !== undefined && localStorage.getItem("access_token") !== null) {
      // include a check here that the access_token isn't expired?
    localStorage.setItem("curState",3)
    } else {
      localStorage.setItem("curState",0)

    }
    window.location.reload();

}
  setLoaded(true);
}, []);


const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('error')) { // Spotify gave an error
  // For future work: better error handling
        console.log("an error was returned.");
        window.alert("An error was given; try refreshing.")
        localStorage.clear();
      } else if (urlParams.get('code') && curState == 0) { // If there is a code URL param and curState is 0, then we are returning from Spotify ready to generate access token

        let code = urlParams.get('code');
        console.log(code);
        console.log("that was the code");
        console.log("about to run gettoken and curstate is " + curState)      

        runGetToken(code);
      
}

async function runGetToken(code) {
  setCurState(2);
  await getToken(code);
  setCurState(3);
  window.history.replaceState(null, '', window.location.pathname); // Get rid of ?code=SDIOFIO90uSDF from the URL
}

  


    return (
      <div>
        <Reactintro />
        <div id="postIntro" ref={postIntroRef}>
          { curState }
          <h1>Welcome to FaceMusic</h1>
          { curState == 0 && <Reactstep1 curState={curState} setCurState={setCurState} /> }
          { curState >= 3 && <Reactstep2 curState={curState} setCurState={setCurState} /> }
         
        </div>
      </div>
    );
  };

  ReactDOM.render(<App />, document.getElementById('root'));

  
</script>

</body>
</html>
