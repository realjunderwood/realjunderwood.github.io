<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple React App</title>

   <link rel="stylesheet" href="react_main.css">

</head>
<body>

<div id="root"></div>


<script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

<!-- REACT COMPONENTS -->
<script type="text/babel" src="react_intro.js"></script>
<script type="text/babel" src="react_step1.js"></script>
<script type="text/babel" src="react_step2.js"></script>
<script type="text/babel" src="react_step2point1.js"></script>
<script type="text/babel" src="react_step2point2.js"></script>
<script type="text/babel" src="react_song.js"></script>



<!-- FUNCTIONAL SCRIPTS -->
 <script src="face-api.min.js"></script> 
 <script src="react_spotify_auth.js"></script>
<!-- <script src="react_webcam.js"></script> -->




<script type="text/babel">


const accessToken = localStorage.getItem("access_token");

const clientId = 'b5ac45b92b3243668cdb8390ab51a04d';
const redirectUri = 'https://www.jamesunderwood.net/facemusic/react_main.html';

const scope = 'user-top-read playlist-modify-private ugc-image-upload';
const authUrl = new URL("https://accounts.spotify.com/authorize")







// var musicGotten = false;
// var curState = localStorage.getItem("curState");




  // Your React code goes here

// if (!localStorage.getItem("curState")) {
//   setState(0)
// }


// var toDisplay = <p></p>;

//   const urlParams = new URLSearchParams(window.location.search);
//     if (urlParams.get("code") && !localStorage.getItem("access_token")) { //Back from spotify
//         setState(0.5)
//         let code = urlParams.get("code");
//         let codeVerifier = localStorage.getItem('code_verifier');
//         getToken(code).then((value) => {
            
//             window.location.href = "https://www.jamesunderwood.net/facemusic/react_main.html";
//         });
//     }









// if (accessToken && curState==0.5) {
//     setState(1);
//     //getMusic(accessToken);
//   }





  const App = () => {
    console.log("const App within react_main.html ")

    const { useEffect, useState, useRef } = React;
    const postIntroRef = useRef(null);

    const [curState, setCurState] = useState(() => {
    // Initialize state from local storage or use a default value
    return parseInt(localStorage.getItem('curState')) || 0;
  });






  useEffect(() => {
    // Update local storage whenever curState changes
    console.log("just got trigerred :(( into setting local storage curstate))");
    console.log(curState);
    localStorage.setItem('curState', curState.toString());


    console.log("hmmm curstate is " + curState)
  if (curState > 0 ) {
   postIntroRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' })

  }

  }, [curState,postIntroRef]);




  const [loaded, setLoaded] = useState(false);


useEffect(() => {
  console.log("ami loaded?")
  console.log(loaded); // to implement: get trackslist from local storage and set not to 2 but to 9 (i think?)
  console.log ("and my curstate is")
  console.log(curState);
  
  console.log("are conditions right for me to setcurstate to 2?")
  console.log (!loaded && ( curState == 7 || curState == 6) )
  if (!loaded && ( curState == 7 || curState == 6)) { // If we just loaded the page and the curstate is one of these
    console.log("this is me setting cur state to 2")
    setCurState(2);
    console.log("it is now curstate " + curState);
    if (localStorage.getItem("access_token") !== undefined && localStorage.getItem("access_token") !== null) {
    localStorage.setItem("curState",2)
    } else {
      localStorage.setItem("curState",0)

    }
    window.location.reload();

}
  setLoaded(true); // Set loaded to true when the component mounts
}, []);


const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('error')) {
   //setCurState(1);

        console.log("an error was returned");
      } else if (urlParams.get('code')) {
         //setCurState(1);
        //console.log("looks like curStaet is 1!!!")


        if (curState == 0) {
        let code = urlParams.get('code');
        console.log(code);
        console.log("that was the code");
        console.log("about to run gettoken and curstate is " + curState)      

        runGetToken(code);
        }
      
}

async function runGetToken(code) {
  console.log("hi");
  await getToken(code);
      console.log("just ran gettoken onthe  code and now accesstoken is " + localStorage.getItem("access_token") + " mm and what is curstate" + curState);

        console.log("Here is where eventually i will replace href and then setcurstate =2")
      //window.history.replaceState(null, '', window.location.pathname);
      setCurState(2);
      //window.location.reload();
}

  

    async function sendToSpotify() {
      setCurState(2)
    }

    return (
      <div>
        <Reactintro />
        <div id="postIntro" ref={postIntroRef}>
          { curState }
          { curState == 0 && <Reactstep1 curState={curState} setCurState={setCurState} /> }
          { curState >= 2 && <Reactstep2 curState={curState} setCurState={setCurState} /> }
          <button
          onClick={sendToSpotify}>hi</button>
        </div>
      </div>
    );
  };

  ReactDOM.render(<App />, document.getElementById('root'));






    // { curState == 0 && <Reactstep1 /> }
            // { curState >= 1 && <Reactstep2 /> }





// function setState(num) {
//   localStorage.setItem("curState",num);
//   curState = num;
// }




  // async function takepicParent() {
  //   setState(3)
  //       await takepicture();
  //       face();
  //   }

  
</script>


<script>



</script>

</body>
</html>
