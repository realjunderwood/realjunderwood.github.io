<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="index.css">
</head>
<body>
<div id="header">
<h1 id="header">
    FaceMusic
</h1>
</div>
<hr>

<h2>We like to listen to music that matches our mood.</h2>
<h2>But there's a problem: Self-identifying whether you are happy or sad requires too much emotional intelligence. Plus, it's hard to remember all the songs you like, and whether they're happy or sad.</h2>
<h2>FaceMusic solves this problem. First, it identifies how happy or sad you are from a picture of your face, no self-evaluation required. Then, it identifies your favorite songs and makes a playlist of those songs that best match your mood.</h2>




<div id="step1">
<h2>
<strong>To start: </strong> connect your Spotify.
</h2>
<button id="connectspotButton" activeColor="#00ff00" class="roundButton" onclick="generateCodeChallenge(64)">Connect with Spotify to get started</button>
</div>


<br>
<br>
<br>

<div id="step2">

    <button class="roundButton" onclick="startVideo()" id="webcamButton">Next, enable webcamnessssss</button>
    <h2>Give permission to webcam</h2>
    <div id="videoContainer">
    <video autoplay="true" id="videoElement">
        
    </video>
    </div>
    <button id="snappicButton" onclick="takepicParent()"><h3 style="display:inline-block">snap picture</h3><img src="camsvg.svg" style="margin-left:10px;vertical-align:middle;" width="30px"></button>

    <canvas id="canvas"> </canvas>
    <p>You're looking pretty <span id="happiness"></span></p>

    <img id="myImg" src="sad.jpeg" width="100px">

</div>



<h1>How it works</h1>
<p>Explain the tech very briefly</p>


<script src="face-api.min.js"></script>

<script src="spotify_auth.js"></script>
<script src="webcam.js"></script>
<script>
    const clientId = 'b5ac45b92b3243668cdb8390ab51a04d';
    const redirectUri = 'https://www.jamesunderwood.net/facemusic';

    const scope = 'user-top-read';
    const authUrl = new URL("https://accounts.spotify.com/authorize")


    if (localStorage.getItem("access_token") == null) {
        //localStorage.clear();
    }
  

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("code") && !localStorage.getItem("access_token")) { //Back from spotify
        console.log("It has been detected that you needa login rn")
        let code = urlParams.get("code");
        let codeVerifier = localStorage.getItem('code_verifier');
        console.log("uhhhsadf hey");
        getToken(code).then((value) => {
            console.log("uhhh hey");
            window.location.href = "https://www.jamesunderwood.net/facemusic";
        });
    } else if (urlParams.get("error")) {
        // say there was an error and remove url param
    } else if (localStorage.getItem("access_token")) { //


        document.getElementById("step2").style.visibility = "visible";
        document.getElementById("step1").style.visibility = "hidden";


        let accessToken = localStorage.getItem("access_token");
        console.log("YOOO there is an acecss token and it is " + accessToken);
        
        getMusic(accessToken);


    } else {



    }













    async function getMusic(accessToken) {

        tracksPool = [];

        for (i = 0; i < 2; i++) {
            console.log("uhhh hey its " + i );
            await getTopArtists(accessToken,49*i).then((value) => {
                //console.log(value);
                // To implement: add to tracksPool top 5 songs of all the top artists

            });

            await getTopTracks(accessToken,49*i).then((value) => {
                //console.log(value);
                for (j=0;j<50;j++) {
                    tracksPool.push(value[j]);
                }

            });
            console.log("ok bbb " + i);
        }


            
        


        
        tracksPoolWithValence = [];

        for (j=0;j<tracksPool.length/50;j++) {
            console.log("j is " + j);
            comSepList = "";
            for (i=j*50; i<50+j*50; i++) {
                console.log("i is " + i);
                //  console.log(i);
                    //console.log(tracksPool[i]);
                comSepList += (i%50 == 0) ? tracksPool[i].id : "," + tracksPool[i].id; //append id to comSepList, with a comma preceding it if it's not the first element
            }
            console.log(comSepList);
            console.log("that was comSepList");
            audFeatures = await getAudioFeatures(accessToken,comSepList);
            audFeatures.forEach(function(val){
                tracksPoolWithValence.push(val);
            });
        
        }


        tracksPoolWithValence.sort(compareSongs)
           
 



    }




    function compareSongs(a,b) {
        if (a.valence > b.valence) {
            return 1;
        }
        if (a.valence < b.valence) {
            return -1;
        }
        return 0;
    }


    async function loadModels() {
        console.log("it's");
        await faceapi.loadFaceExpressionModel('/facemusic/models');
        await faceapi.loadSsdMobilenetv1Model('/facemusic/models')
        console.log("it is");
    }


    async function face() { //Convert expression confidence scores to happiness level
        const input = document.getElementById('myImg');
        
        const detectionWithExpressions = await faceapi.detectSingleFace(input).withFaceExpressions();
        console.log(detectionWithExpressions);
        console.log("Happy / sad : " + detectionWithExpressions.expressions.happy/detectionWithExpressions.expressions.sad);
        console.log(detectionWithExpressions.expressions.happy);
        hapsadneutSum = detectionWithExpressions.expressions.happy + detectionWithExpressions.expressions.sad + detectionWithExpressions.expressions.neutral;
        happy = detectionWithExpressions.expressions.happy / hapsadneutSum;
       // happy = (happy*0.75)+(1/12)
        // sad = detectionWithExpressions.expressions.sad / hapsadneutSum;
        neutral = detectionWithExpressions.expressions.neutral / hapsadneutSum;
        //neutral = (neutral*0.75)+(1/12)
        document.getElementById("happiness").innerText = happy + 0.4*neutral;

    }
    face();



    async function takepicParent() {
        await takepicture();
        face();
    }










    


    loadModels();

</script>
</body>
</html>